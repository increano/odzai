<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Actual Budget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        header {
            background-color: #2e7d32;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        nav {
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 0.5rem;
        }
        nav button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: 4px;
        }
        nav button.active {
            background-color: #c8e6c9;
        }
        .container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .hidden {
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        form {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        form div {
            margin-bottom: 0.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.3rem;
        }
        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button[type="submit"] {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <header>
        <h1>Minimal Actual Budget</h1>
    </header>
    
    <nav>
        <button id="budgets-btn">Budgets</button>
        <button id="accounts-btn">Accounts</button>
        <button id="transactions-btn">Transactions</button>
        <button id="budget-btn">Budget</button>
    </nav>
    
    <div class="container">
        <!-- Budgets Section -->
        <section id="budgets-section">
            <h2>Budgets</h2>
            <table id="budgets-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="budgets-body"></tbody>
            </table>
        </section>
        
        <!-- Accounts Section -->
        <section id="accounts-section" class="hidden">
            <h2>Accounts</h2>
            <table id="accounts-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Balance</th>
                        <th>Type</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="accounts-body"></tbody>
            </table>
            
            <form id="add-account-form">
                <h3>Add Account</h3>
                <div>
                    <label for="account-name">Name</label>
                    <input type="text" id="account-name" required>
                </div>
                <div>
                    <label for="account-type">Type</label>
                    <select id="account-type" required>
                        <option value="checking">Checking</option>
                        <option value="savings">Savings</option>
                        <option value="credit">Credit Card</option>
                        <option value="investment">Investment</option>
                    </select>
                </div>
                <div>
                    <label for="initial-balance">Initial Balance</label>
                    <input type="number" id="initial-balance" value="0">
                </div>
                <button type="submit">Add Account</button>
            </form>
        </section>
        
        <!-- Transactions Section -->
        <section id="transactions-section" class="hidden">
            <h2>Transactions</h2>
            <div>
                <label for="account-select">Select Account</label>
                <select id="account-select"></select>
            </div>
            
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Payee</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="transactions-body"></tbody>
            </table>
            
            <form id="add-transaction-form">
                <h3>Add Transaction</h3>
                <div>
                    <label for="transaction-date">Date</label>
                    <input type="date" id="transaction-date" required>
                </div>
                <div>
                    <label for="transaction-payee">Payee</label>
                    <input type="text" id="transaction-payee" required>
                </div>
                <div>
                    <label for="transaction-category">Category</label>
                    <select id="transaction-category"></select>
                </div>
                <div>
                    <label for="transaction-amount">Amount</label>
                    <input type="number" id="transaction-amount" step="0.01" required>
                </div>
                <div>
                    <label for="transaction-notes">Notes</label>
                    <input type="text" id="transaction-notes">
                </div>
                <button type="submit">Add Transaction</button>
            </form>
        </section>
        
        <!-- Budget Section -->
        <section id="budget-section" class="hidden">
            <h2>Budget</h2>
            <div>
                <label for="month-select">Select Month</label>
                <select id="month-select"></select>
            </div>
            
            <table id="budget-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Budgeted</th>
                        <th>Activity</th>
                        <th>Available</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="budget-body"></tbody>
            </table>
        </section>
    </div>
    
    <script>
        // Navigation
        document.getElementById('budgets-btn').addEventListener('click', () => showSection('budgets'));
        document.getElementById('accounts-btn').addEventListener('click', () => showSection('accounts'));
        document.getElementById('transactions-btn').addEventListener('click', () => showSection('transactions'));
        document.getElementById('budget-btn').addEventListener('click', () => showSection('budget'));
        
        function showSection(section) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`${section}-section`).classList.remove('hidden');
            document.getElementById(`${section}-btn`).classList.add('active');
            
            if (section === 'budgets') loadBudgets();
            if (section === 'accounts') loadAccounts();
            if (section === 'transactions') {
                loadAccounts().then(() => {
                    const accountSelect = document.getElementById('account-select');
                    if (accountSelect.value) loadTransactions(accountSelect.value);
                });
                loadCategories();
            }
            if (section === 'budget') {
                loadBudgetMonths().then(() => {
                    const monthSelect = document.getElementById('month-select');
                    if (monthSelect.value) loadBudgetMonth(monthSelect.value);
                });
            }
        }
        
        // Load Budgets
        async function loadBudgets() {
            try {
                const response = await fetch('/api/budgets');
                const budgets = await response.json();
                
                const tbody = document.getElementById('budgets-body');
                tbody.innerHTML = '';
                
                budgets.forEach(budget => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${budget.id}</td>
                        <td>${budget.name || budget.id}</td>
                        <td><button onclick="loadBudget('${budget.id}')">Load</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load budgets:', error);
            }
        }
        
        // Load Budget
        async function loadBudget(budgetId) {
            try {
                const response = await fetch('/api/budgets/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ budgetId })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert(`Budget ${budgetId} loaded successfully`);
                    showSection('accounts');
                }
            } catch (error) {
                console.error('Failed to load budget:', error);
                alert('Failed to load budget');
            }
        }
        
        // Load Accounts
        async function loadAccounts() {
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();
                
                const tbody = document.getElementById('accounts-body');
                tbody.innerHTML = '';
                
                accounts.forEach(account => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${account.name}</td>
                        <td>${formatCurrency(account.balance)}</td>
                        <td>${account.type || 'N/A'}</td>
                        <td><button onclick="viewTransactions('${account.id}')">View Transactions</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Also update the account select dropdown
                const accountSelect = document.getElementById('account-select');
                accountSelect.innerHTML = '<option value="">Select Account</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    accountSelect.appendChild(option);
                });
                
                // Add change event to load transactions
                accountSelect.onchange = () => {
                    if (accountSelect.value) loadTransactions(accountSelect.value);
                };
                
                return accounts;
            } catch (error) {
                console.error('Failed to load accounts:', error);
                return [];
            }
        }
        
        // Add Account
        document.getElementById('add-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('account-name').value;
            const type = document.getElementById('account-type').value;
            const initialBalance = parseFloat(document.getElementById('initial-balance').value) || 0;
            
            try {
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account: { name, type },
                        initialBalance
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Account added successfully');
                    document.getElementById('add-account-form').reset();
                    loadAccounts();
                }
            } catch (error) {
                console.error('Failed to add account:', error);
                alert('Failed to add account');
            }
        });
        
        // View Transactions for Account
        function viewTransactions(accountId) {
            document.getElementById('account-select').value = accountId;
            loadTransactions(accountId);
            showSection('transactions');
        }
        
        // Load Transactions
        async function loadTransactions(accountId) {
            try {
                const response = await fetch(`/api/transactions/${accountId}`);
                const transactions = await response.json();
                
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = '';
                
                transactions.forEach(transaction => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.payee || 'N/A'}</td>
                        <td>${transaction.category || 'N/A'}</td>
                        <td>${formatCurrency(transaction.amount)}</td>
                        <td><button onclick="editTransaction('${transaction.id}')">Edit</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load transactions:', error);
            }
        }
        
        // Load Categories
        async function loadCategories() {
            try {
                const response = await fetch('/api/categories');
                const categories = await response.json();
                
                const categorySelect = document.getElementById('transaction-category');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                return categories;
            } catch (error) {
                console.error('Failed to load categories:', error);
                return [];
            }
        }
        
        // Add Transaction
        document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const accountId = document.getElementById('account-select').value;
            if (!accountId) {
                alert('Please select an account');
                return;
            }
            
            const date = document.getElementById('transaction-date').value;
            const payee = document.getElementById('transaction-payee').value;
            const categoryId = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const notes = document.getElementById('transaction-notes').value;
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountId,
                        transaction: {
                            date,
                            payee_name: payee,
                            category_id: categoryId,
                            amount: Math.round(amount * 100), // Convert to cents
                            notes
                        }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    alert('Transaction added successfully');
                    document.getElementById('add-transaction-form').reset();
                    loadTransactions(accountId);
                }
            } catch (error) {
                console.error('Failed to add transaction:', error);
                alert('Failed to add transaction');
            }
        });
        
        // Load Budget Months
        async function loadBudgetMonths() {
            try {
                const response = await fetch('/api/budget/months');
                const months = await response.json();
                
                const monthSelect = document.getElementById('month-select');
                monthSelect.innerHTML = '';
                
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = formatMonth(month);
                    monthSelect.appendChild(option);
                });
                
                // Add change event to load budget month
                monthSelect.onchange = () => {
                    if (monthSelect.value) loadBudgetMonth(monthSelect.value);
                };
                
                return months;
            } catch (error) {
                console.error('Failed to load budget months:', error);
                return [];
            }
        }
        
        // Load Budget Month
        async function loadBudgetMonth(month) {
            try {
                const response = await fetch(`/api/budget/month/${month}`);
                const budget = await response.json();
                
                const tbody = document.getElementById('budget-body');
                tbody.innerHTML = '';
                
                if (budget.categories) {
                    budget.categories.forEach(category => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${category.name}</td>
                            <td>${formatCurrency(category.budgeted)}</td>
                            <td>${formatCurrency(category.activity)}</td>
                            <td>${formatCurrency(category.available)}</td>
                            <td><button onclick="setBudgetAmount('${month}', '${category.id}')">Set Budget</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            } catch (error) {
                console.error('Failed to load budget month:', error);
            }
        }
        
        // Set Budget Amount
        function setBudgetAmount(month, categoryId) {
            const amount = prompt('Enter budget amount:');
            if (amount === null) return;
            
            fetch('/api/budget/set-amount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    month,
                    categoryId,
                    amount: Math.round(parseFloat(amount) * 100) // Convert to cents
                })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Budget updated successfully');
                    loadBudgetMonth(month);
                }
            })
            .catch(error => {
                console.error('Failed to set budget amount:', error);
                alert('Failed to set budget amount');
            });
        }
        
        // Helper Functions
        function formatCurrency(cents) {
            if (cents === undefined || cents === null) return '$0.00';
            const dollars = cents / 100;
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(dollars);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('en-US').format(date);
        }
        
        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long' }).format(new Date(parseInt(year), parseInt(month) - 1));
        }
        
        // Initialize
        showSection('budgets');
    </script>
</body>
</html> 