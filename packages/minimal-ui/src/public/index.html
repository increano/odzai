<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minimal Actual Budget</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            color: #333;
        }
        header {
            background-color: #2e7d32;
            color: white;
            padding: 1rem;
            text-align: center;
        }
        .status-indicator {
            background-color: #f8d7da;
            color: #721c24;
            padding: 0.5rem;
            text-align: center;
            font-size: 0.9rem;
            display: none;
        }
        .status-indicator.active {
            display: block;
        }
        .status-indicator.success {
            background-color: #d4edda;
            color: #155724;
        }
        nav {
            background-color: #f5f5f5;
            border-bottom: 1px solid #ddd;
            padding: 0.5rem;
        }
        nav button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            background-color: #e0e0e0;
            cursor: pointer;
            border-radius: 4px;
        }
        nav button.active {
            background-color: #c8e6c9;
        }
        nav button:disabled {
            background-color: #f5f5f5;
            color: #aaa;
            cursor: not-allowed;
        }
        .container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
        .hidden {
            display: none;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 0.5rem;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        form {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f5f5f5;
            border-radius: 4px;
        }
        form div {
            margin-bottom: 0.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.3rem;
        }
        input, select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button[type="submit"] {
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            padding: 0.5rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
        }
        .error-message.active {
            display: block;
        }
        .no-budgets-message {
            text-align: center;
            margin: 2rem 0;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 4px;
        }
        .sample-budget-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 1rem auto;
            padding: 0.75rem 1rem;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }
        .sample-budget-btn:hover {
            background-color: #1b5e20;
        }
        .loading {
            text-align: center;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <header>
        <h1>Minimal Actual Budget</h1>
    </header>
    
    <div id="status-bar" class="status-indicator">
        No budget loaded. Please select a budget file.
    </div>
    
    <nav>
        <button id="budgets-btn">Budgets</button>
        <button id="accounts-btn" disabled>Accounts</button>
        <button id="transactions-btn" disabled>Transactions</button>
        <button id="budget-btn" disabled>Budget</button>
    </nav>
    
    <div class="container">
        <div id="error-message" class="error-message"></div>
        
        <!-- Budgets Section -->
        <section id="budgets-section">
            <h2>Budgets</h2>
            <div id="budgets-loading" class="loading">Loading budgets...</div>
            <div id="no-budgets-message" class="no-budgets-message hidden">
                <p>No budgets found. Please use the full Actual application to create a budget first, then return here.</p>
                <p><strong>Important:</strong> Make sure both applications use the same data directory!</p>
                <p>Current data directory: <code id="current-data-dir"></code></p>
            </div>
            <table id="budgets-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="budgets-body"></tbody>
            </table>
        </section>
        
        <!-- Accounts Section -->
        <section id="accounts-section" class="hidden">
            <h2>Accounts</h2>
            <table id="accounts-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Balance</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="accounts-body"></tbody>
            </table>
            
            <form id="add-account-form">
                <h3>Add Account</h3>
                <div>
                    <label for="account-name">Name</label>
                    <input type="text" id="account-name" required>
                </div>
                <div>
                    <label for="offbudget">
                        <input type="checkbox" id="offbudget"> Off Budget (excluded from budget calculations)
                    </label>
                </div>
                <div>
                    <label for="initial-balance">Initial Balance</label>
                    <input type="number" id="initial-balance" value="0">
                </div>
                <button type="submit">Add Account</button>
            </form>
        </section>
        
        <!-- Transactions Section -->
        <section id="transactions-section" class="hidden">
            <h2>Transactions</h2>
            <div>
                <label for="account-select">Select Account</label>
                <select id="account-select"></select>
            </div>
            
            <table id="transactions-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Payee</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="transactions-body"></tbody>
            </table>
            
            <form id="add-transaction-form">
                <h3>Add Transaction</h3>
                <div>
                    <label for="transaction-date">Date</label>
                    <input type="date" id="transaction-date" required>
                </div>
                <div>
                    <label for="transaction-payee">Payee</label>
                    <input type="text" id="transaction-payee" required>
                </div>
                <div>
                    <label for="transaction-category">Category</label>
                    <select id="transaction-category"></select>
                </div>
                <div>
                    <label for="transaction-amount">Amount</label>
                    <input type="number" id="transaction-amount" step="0.01" required>
                </div>
                <div>
                    <label for="transaction-notes">Notes</label>
                    <input type="text" id="transaction-notes">
                </div>
                <button type="submit">Add Transaction</button>
            </form>
        </section>
        
        <!-- Budget Section -->
        <section id="budget-section" class="hidden">
            <h2>Budget</h2>
            <div>
                <label for="month-select">Select Month</label>
                <select id="month-select"></select>
            </div>
            
            <table id="budget-table">
                <thead>
                    <tr>
                        <th>Category</th>
                        <th>Budgeted</th>
                        <th>Activity</th>
                        <th>Available</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="budget-body"></tbody>
            </table>
        </section>
    </div>
    
    <script>
        // Global state
        let isBudgetLoaded = false;
        
        // Helper to show errors
        function showError(message) {
            const errorEl = document.getElementById('error-message');
            errorEl.textContent = message;
            errorEl.classList.add('active');
            setTimeout(() => {
                errorEl.classList.remove('active');
            }, 5000);
        }
        
        // Helper to handle API responses
        async function handleApiResponse(response) {
            const data = await response.json();
            if (!response.ok) {
                const errorMessage = data.message || data.error || 'Unknown error occurred';
                showError(errorMessage);
                throw new Error(errorMessage);
            }
            return data;
        }
        
        // Get and display the data directory
        async function getDataDirectory() {
            try {
                const response = await fetch('/api/data-directory');
                const data = await handleApiResponse(response);
                document.getElementById('current-data-dir').textContent = data.dataDir;
            } catch (error) {
                console.error('Failed to get data directory:', error);
                document.getElementById('current-data-dir').textContent = 'Unknown';
            }
        }
        
        // Check budget status on page load
        async function checkBudgetStatus() {
            try {
                const response = await fetch('/api/budget-status');
                const data = await handleApiResponse(response);
                updateBudgetStatus(data.budgetLoaded);
            } catch (error) {
                console.error('Failed to check budget status:', error);
                updateBudgetStatus(false);
            }
        }
        
        // Update UI based on budget status
        function updateBudgetStatus(isLoaded) {
            isBudgetLoaded = isLoaded;
            const statusBar = document.getElementById('status-bar');
            const accountsBtn = document.getElementById('accounts-btn');
            const transactionsBtn = document.getElementById('transactions-btn');
            const budgetBtn = document.getElementById('budget-btn');
            
            if (isLoaded) {
                statusBar.textContent = 'Budget loaded successfully';
                statusBar.classList.add('success', 'active');
                accountsBtn.disabled = false;
                transactionsBtn.disabled = false;
                budgetBtn.disabled = false;
            } else {
                statusBar.textContent = 'No budget loaded. Please select a budget file.';
                statusBar.classList.remove('success');
                statusBar.classList.add('active');
                accountsBtn.disabled = true;
                transactionsBtn.disabled = true;
                budgetBtn.disabled = true;
            }
        }
        
        // Navigation
        document.getElementById('budgets-btn').addEventListener('click', () => showSection('budgets'));
        document.getElementById('accounts-btn').addEventListener('click', () => {
            if (isBudgetLoaded) showSection('accounts');
        });
        document.getElementById('transactions-btn').addEventListener('click', () => {
            if (isBudgetLoaded) showSection('transactions');
        });
        document.getElementById('budget-btn').addEventListener('click', () => {
            if (isBudgetLoaded) showSection('budget');
        });
        
        function showSection(section) {
            document.querySelectorAll('section').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`${section}-section`).classList.remove('hidden');
            document.getElementById(`${section}-btn`).classList.add('active');
            
            if (section === 'budgets') loadBudgets();
            if (section === 'accounts' && isBudgetLoaded) loadAccounts();
            if (section === 'transactions' && isBudgetLoaded) {
                loadAccounts().then(() => {
                    const accountSelect = document.getElementById('account-select');
                    if (accountSelect.value) loadTransactions(accountSelect.value);
                });
                loadCategories();
            }
            if (section === 'budget' && isBudgetLoaded) {
                loadBudgetMonths().then(() => {
                    const monthSelect = document.getElementById('month-select');
                    if (monthSelect.value) loadBudgetMonth(monthSelect.value);
                });
            }
        }
        
        // Load Budgets
        async function loadBudgets() {
            try {
                // Show loading
                document.getElementById('budgets-loading').classList.remove('hidden');
                document.getElementById('budgets-table').classList.add('hidden');
                document.getElementById('no-budgets-message').classList.add('hidden');
                
                const response = await fetch('/api/budgets');
                const budgets = await handleApiResponse(response);
                
                // Hide loading
                document.getElementById('budgets-loading').classList.add('hidden');
                
                const tbody = document.getElementById('budgets-body');
                tbody.innerHTML = '';
                
                if (budgets.length === 0) {
                    document.getElementById('no-budgets-message').classList.remove('hidden');
                    document.getElementById('budgets-table').classList.add('hidden');
                    return;
                }
                
                document.getElementById('budgets-table').classList.remove('hidden');
                
                budgets.forEach(budget => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${budget.id}</td>
                        <td>${budget.name || budget.id}</td>
                        <td><button onclick="loadBudget('${budget.id}')">Load</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load budgets:', error);
                document.getElementById('budgets-loading').classList.add('hidden');
                document.getElementById('no-budgets-message').classList.remove('hidden');
            }
        }
        
        // Load Budget
        async function loadBudget(budgetId) {
            try {
                const response = await fetch('/api/budgets/load', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ budgetId })
                });
                
                const result = await handleApiResponse(response);
                if (result.success) {
                    updateBudgetStatus(true);
                    showSection('accounts');
                }
            } catch (error) {
                console.error('Failed to load budget:', error);
                updateBudgetStatus(false);
            }
        }
        
        // Load Accounts
        async function loadAccounts() {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return [];
            }
            
            try {
                const response = await fetch('/api/accounts');
                const accounts = await handleApiResponse(response);
                
                // Debug log to see account structure
                console.log("Account data:", accounts);
                
                const tbody = document.getElementById('accounts-body');
                tbody.innerHTML = '';
                
                if (accounts.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4">No accounts found. Add one to get started.</td></tr>';
                } else {
                    accounts.forEach(account => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${account.name}</td>
                            <td>${formatCurrency(account.calculated_balance)}</td>
                            <td><button onclick="viewTransactions('${account.id}')">View Transactions</button></td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
                
                // Also update the account select dropdown
                const accountSelect = document.getElementById('account-select');
                accountSelect.innerHTML = '<option value="">Select Account</option>';
                
                accounts.forEach(account => {
                    const option = document.createElement('option');
                    option.value = account.id;
                    option.textContent = account.name;
                    accountSelect.appendChild(option);
                });
                
                // Add change event to load transactions
                accountSelect.onchange = () => {
                    if (accountSelect.value) loadTransactions(accountSelect.value);
                };
                
                return accounts;
            } catch (error) {
                console.error('Failed to load accounts:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
                return [];
            }
        }
        
        // Add Account
        document.getElementById('add-account-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            const name = document.getElementById('account-name').value;
            const offBudget = document.getElementById('offbudget').checked;
            const initialBalance = parseFloat(document.getElementById('initial-balance').value) || 0;
            
            try {
                const response = await fetch('/api/accounts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        account: { name, offBudget },
                        initialBalance: Math.round(initialBalance * 100) // Convert to cents
                    })
                });
                
                const result = await handleApiResponse(response);
                if (result.success) {
                    document.getElementById('add-account-form').reset();
                    // Wait a moment for the initial balance transaction to be processed
                    setTimeout(() => {
                        loadAccounts();
                    }, 500);
                }
            } catch (error) {
                console.error('Failed to add account:', error);
            }
        });
        
        // View Transactions for Account
        function viewTransactions(accountId) {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            document.getElementById('account-select').value = accountId;
            loadTransactions(accountId);
            showSection('transactions');
        }
        
        // Load Transactions
        async function loadTransactions(accountId) {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            try {
                const response = await fetch(`/api/transactions/${accountId}`);
                const transactions = await handleApiResponse(response);
                
                const tbody = document.getElementById('transactions-body');
                tbody.innerHTML = '';
                
                if (transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No transactions found for this account.</td></tr>';
                    return;
                }
                
                transactions.forEach(transaction => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatDate(transaction.date)}</td>
                        <td>${transaction.payee || 'N/A'}</td>
                        <td>${transaction.category || 'N/A'}</td>
                        <td>${formatCurrency(transaction.amount)}</td>
                        <td><button onclick="editTransaction('${transaction.id}')">Edit</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load transactions:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
            }
        }
        
        // Load Categories
        async function loadCategories() {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return [];
            }
            
            try {
                const response = await fetch('/api/categories');
                const categories = await handleApiResponse(response);
                
                const categorySelect = document.getElementById('transaction-category');
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
                
                return categories;
            } catch (error) {
                console.error('Failed to load categories:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
                return [];
            }
        }
        
        // Add Transaction
        document.getElementById('add-transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            const accountId = document.getElementById('account-select').value;
            if (!accountId) {
                showError('Please select an account');
                return;
            }
            
            const date = document.getElementById('transaction-date').value;
            const payee = document.getElementById('transaction-payee').value;
            const categoryId = document.getElementById('transaction-category').value;
            const amount = parseFloat(document.getElementById('transaction-amount').value);
            const notes = document.getElementById('transaction-notes').value;
            
            try {
                const response = await fetch('/api/transactions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accountId,
                        transaction: {
                            date,
                            payee_name: payee,
                            category: categoryId,
                            amount: Math.round(amount * 100), // Convert to cents
                            notes
                        }
                    })
                });
                
                const result = await handleApiResponse(response);
                if (result.success) {
                    document.getElementById('add-transaction-form').reset();
                    loadTransactions(accountId);
                }
            } catch (error) {
                console.error('Failed to add transaction:', error);
            }
        });
        
        // Load Budget Months
        async function loadBudgetMonths() {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return [];
            }
            
            try {
                const response = await fetch('/api/budget/months');
                const months = await handleApiResponse(response);
                
                const monthSelect = document.getElementById('month-select');
                monthSelect.innerHTML = '';
                
                if (months.length === 0) {
                    showError('No budget months found');
                    return [];
                }
                
                months.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = formatMonth(month);
                    monthSelect.appendChild(option);
                });
                
                // Add change event to load budget month
                monthSelect.onchange = () => {
                    if (monthSelect.value) loadBudgetMonth(monthSelect.value);
                };
                
                return months;
            } catch (error) {
                console.error('Failed to load budget months:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
                return [];
            }
        }
        
        // Load Budget Month
        async function loadBudgetMonth(month) {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            try {
                const response = await fetch(`/api/budget/month/${month}`);
                const budget = await handleApiResponse(response);
                
                const tbody = document.getElementById('budget-body');
                tbody.innerHTML = '';
                
                if (!budget.categories || budget.categories.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No categories found for this month.</td></tr>';
                    return;
                }
                
                budget.categories.forEach(category => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${category.name}</td>
                        <td>${formatCurrency(category.budgeted)}</td>
                        <td>${formatCurrency(category.activity)}</td>
                        <td>${formatCurrency(category.available)}</td>
                        <td><button onclick="setBudgetAmount('${month}', '${category.id}')">Set Budget</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (error) {
                console.error('Failed to load budget month:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
            }
        }
        
        // Set Budget Amount
        function setBudgetAmount(month, categoryId) {
            if (!isBudgetLoaded) {
                showError('Please load a budget first');
                showSection('budgets');
                return;
            }
            
            const amount = prompt('Enter budget amount:');
            if (amount === null) return;
            
            fetch('/api/budget/set-amount', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    month,
                    categoryId,
                    amount: Math.round(parseFloat(amount) * 100) // Convert to cents
                })
            })
            .then(response => handleApiResponse(response))
            .then(result => {
                if (result.success) {
                    loadBudgetMonth(month);
                }
            })
            .catch(error => {
                console.error('Failed to set budget amount:', error);
                if (error.message && error.message.includes('No budget file is open')) {
                    updateBudgetStatus(false);
                    showSection('budgets');
                }
            });
        }
        
        // Helper Functions
        function formatCurrency(cents) {
            if (cents === undefined || cents === null) return '$0.00';
            const dollars = cents / 100;
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(dollars);
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('en-US').format(date);
        }
        
        function formatMonth(monthString) {
            const [year, month] = monthString.split('-');
            return new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'long' }).format(new Date(parseInt(year), parseInt(month) - 1));
        }
        
        // Initialize
        checkBudgetStatus().then(() => {
            showSection('budgets');
            getDataDirectory();
        });
    </script>
</body>
</html> 